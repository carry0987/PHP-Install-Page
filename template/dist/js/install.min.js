!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("@carry0987/utils-full"),require("sweetalert2")):"function"==typeof define&&define.amd?define(["@carry0987/utils-full","sweetalert2"],e):(t="undefined"!=typeof globalThis?globalThis:t||self).InstallHelper=e(t.Utils,t.Swal)}(this,(function(t,e){"use strict";if(!t)throw new Error("Utils not found");if(!$)throw new Error("jQuery not found");class s{act_btn;inputActions={};static backURL="../";constructor(){this.act_btn={}}init(){this.checkInstalled(),this.initValidation()}showMsg=(t,e,s="#display")=>{const a=(t?"<span style='color: green'>":"<span style='color: red'>")+e+"</span>";$(s).html(a)};checkInput=(t,e)=>{const s=t.val()?.toString().trim();return s?(this.showMsg(!0,""),!0):(this.showMsg(!1,e),!1)};checkPasswordLength=(t,e)=>{const s=t.val()?.toString().trim();return!s||s.length<8?(this.showMsg(!1,e),!1):(this.showMsg(!0,""),!0)};checkPasswordConfirmation=(t,e,s)=>t.val()!==e.val()?(this.showMsg(!1,s),!1):(this.showMsg(!0,""),!0);validateInputs=()=>{const t=$("#install input").not('[type="submit"]'),e=$("#display > span").is(":empty"),s=t.toArray().some((t=>!t.value.trim().length));t.each(((t,e)=>{const s=$(e);e.value.trim().length?s.removeClass("bg-danger-subtle"):s.addClass("bg-danger-subtle")})),$("#submit").prop("disabled",s||!e)};async sendFormData(e,s,a="POST",i,n){return t.sendFormData({url:e,method:a,data:s,success:i,errorCallback:n})}fetchData=(e,s,a="POST",i=null)=>{let n="api.php";return i&&(n+="?"+i),new Promise(((i,o)=>{t.doFetch({url:n,method:a,body:t.encodeFormData(e),success:function(t){i(s(t))},error:function(t){o(t)}})}))};async showSwal(s){const{title:a,text:i,html:n,beforeConfirm:o,callback:l,showLoading:r}=s;delete s.callback;let d={title:a?.toString()??"",text:i?.toString()??"",html:n??void 0,focusConfirm:!1,showCancelButton:!1,showCloseButton:!1,showDenyButton:!1,showConfirmButton:!1,allowOutsideClick:!r,allowEnterKey:!r,allowEscapeKey:!r};d=t.deepMerge({},d,s),r&&!d.didOpen&&(d.didOpen=()=>{e.showLoading()});return await e.fire(d).then((t=>(o&&o(t),(t.isConfirmed||t.isDismissed)&&l&&l(t),t)))}async langList(){return this.fetchData({request:"get_language"},(t=>t.lang))}async checkInstalled(){const t=new FormData,a=await this.langList();await this.sendFormData("api.php",{request:"check_installed",data:t},"POST",(async t=>{e.hideLoading(),!0===t&&($("#install, #form-title").hide(),await this.showSwal({icon:"error",text:a.install.installed,showConfirmButton:!0}).then((t=>{t.isConfirmed&&(window.location.href=s.backURL)})))}),(async t=>{await this.showSwal({title:"Error",text:t,icon:"error"})}))}buildInputActions(){this.inputActions={admin:{method:this.checkInput,messageKey:"username_empty"},admin_psw:{method:this.checkPasswordLength,messageKey:"password_rule"},admin_psw_confirm:{method:this.checkPasswordConfirmation,messageKey:"repassword_error"},db_host:{method:this.checkInput,messageIdx:"database",messageKey:"db_host_empty"},db_port:{method:this.checkInput,messageIdx:"database",messageKey:"db_port_empty"},db_name:{method:this.checkInput,messageIdx:"database",messageKey:"db_name_empty"},db_user:{method:this.checkInput,messageIdx:"database",messageKey:"db_user_empty"},db_password:{method:this.checkInput,messageIdx:"database",messageKey:"db_password_empty"}}}async initValidation(){const t=await this.langList();this.buildInputActions(),$("#install").on("input blur propertychange","input",(e=>{const s=e.target.id,a=this.inputActions[s];if(a&&"function"==typeof a.method){const i=a.messageIdx?a.messageIdx:"install";"admin_psw_confirm"===s?a.method($("#admin_psw"),$(e.target),t[i][a.messageKey]):a.method($(e.target),t[i][a.messageKey])}})),$("#install").on("input","input",(t=>{$(t.target).removeClass("bg-danger-subtle")})),$("#install").on("input blur","input",(()=>{this.validateInputs()})),$("#install").on("submit",(async a=>{a.preventDefault(),this.validateInputs();const i=this.checkInput($("#admin"),t.install.username_empty),n=this.checkInput($("#admin_psw"),t.install.password_rule),o=this.checkPasswordConfirmation($("#admin_psw"),$("#admin_psw_confirm"),t.install.repassword_error);if(!i||!n||!o)return!1;if(!$(a.target).find("#submit").prop("disabled")){const i=new FormData(a.target),n={};for(let[t,e]of i.entries())n[t]=e;await this.showSwal({text:t.install.installing,showConfirmButton:!1,allowOutsideClick:!1,allowEnterKey:!1,allowEscapeKey:!1,willOpen:()=>{$("#install, #form-title").hide()},didOpen:()=>{this.showSwal({text:t.install.installing,allowOutsideClick:!1,allowEnterKey:!1,allowEscapeKey:!1,showLoading:!0,willOpen:async()=>{$("#install, #form-title").hide(),n.request="start_install",await this.sendFormData("api.php",n,"POST",(function(a){e.hideLoading(),!0===a.status?e.fire({icon:"success",html:t.install.install_success+"<br>"+t.install.install_remove}).then((t=>{t.isConfirmed&&(window.location.href=s.backURL)})):e.fire({icon:"error",text:a.message}).then((t=>{t.isConfirmed&&window.location.reload()}))}),(async t=>{await this.showSwal({title:"Error",text:t,icon:"error"})}))}})},didClose:()=>{$("#install, #form-title").show()}})}}))}}return s}));
